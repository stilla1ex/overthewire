import os
import django

# Set up Django environment
os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'myapp.settings')
django.setup()

from myapp.models import UploadedFile 

# Analyze file content
def analyze_file(file_content):
    harmful_keywords = ['malware', 'virus', 'exploit', 'trojan']
    file_content = file_content.decode('utf-8')  # Decode binary content to string
    analysis_result = {
        'harmful_keywords_found': [],
        'is_harmful': False
    }

    for keyword in harmful_keywords:
        if keyword in file_content.lower():
            analysis_result['harmful_keywords_found'].append(keyword)
            analysis_result['is_harmful'] = True

    return analysis_result

# Main function to analyze all files
def analyze_all_files():
    files = UploadedFile.objects.filter(status='pending')  # Analyze only pending files
    for file in files:
        analysis_result = analyze_file(file.file_content)
        print(f"Analyzing file: {file.file_name}")
        print(f"Analysis Result: {analysis_result}")
        print("-" * 40)

        # Update file status
        if analysis_result['is_harmful']:
            file.status = 'harmful'
        else:
            file.status = 'safe'
        file.save()

if __name__ == "__main__":
    analyze_all_files()