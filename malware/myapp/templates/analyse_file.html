{% extends 'base.html' %}

{% block content %}
<h2>Analyse File</h2>

<!-- File Details -->
<div class="bg-gray-800 p-6 rounded-lg mb-8">
  <h3 class="text-gray-400 mb-4">File Details</h3>
  <div class="space-y-2">
    <p><span class="font-semibold">File Name:</span> {{ file.file_name }}</p>
    <p><span class="font-semibold">Size:</span> {{ file.file_size|filesizeformat }}</p>
    <p><span class="font-semibold">Status:</span> 
      <span class="{% if file.threat_level == 'safe' %}text-green-400{% elif file.threat_level == 'harmful' %}text-red-400{% else %}text-yellow-400{% endif %}">
        {{ file.get_threat_level_display }}
      </span>
    </p>
    <p><span class="font-semibold">Uploaded At:</span> {{ file.uploaded_at }}</p>
  </div>
</div>

<!-- Analysis Results -->
<div class="bg-gray-800 p-6 rounded-lg">
  <div class="flex items-center justify-between mb-4">
    <h3 class="text-gray-400">Analysis Results</h3>
    <a href="{% url 'analyse_file' file.id %}?download=true" class="inline-block bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">
      Download Report
    </a>
  </div>
  <div class="space-y-4">
    <p><span class="font-semibold">Threat Level:</span> 
      <span class="{% if file.threat_level == 'safe' %}text-green-400{% elif file.threat_level == 'harmful' %}text-red-400{% else %}text-yellow-400{% endif %}">
        {{ file.get_threat_level_display }}
      </span>
    </p>
  </div>
</div>

<!-- Trigger Analysis Button -->
<div class="mt-8">
  <button onclick="triggerAnalysis({{ file.id }})" class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600">
    <i class="bi bi-bar-chart-fill"></i> Re-analyze File
  </button>
</div>

<!-- JavaScript to handle re-analysis -->
<script>
  function triggerAnalysis(fileId) {
    // Show loading overlay
    document.getElementById('loading-overlay').classList.remove('hidden');

    // Send a request to the server to re-analyze the file
    fetch(`/analyse_file/${fileId}/`)
      .then(response => response.json())
      .then(data => {
        // Reload the page to reflect the updated analysis results
        window.location.reload();
      })
      .catch(error => {
        console.error('Error:', error);
        // Hide loading overlay
        document.getElementById('loading-overlay').classList.add('hidden');
      });
  }
</script>

<!-- Full-page loading overlay (hidden by default) -->
<div id="loading-overlay" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center hidden z-50">
  <div class="flex flex-col items-center">
    <!-- Spinning Loader -->
    <div class="w-16 h-16 border-t-4 border-blue-500 border-solid rounded-full animate-spin"></div>
    <p class="mt-4 text-gray-300 font-semibold">Analyzing...</p>
  </div>
</div>
{% endblock %}